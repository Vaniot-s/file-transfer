<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>文件管理</title>
<meta name="description" content="">
<meta name="keywords" content="">
<link href="" rel="stylesheet">
<style>
   *{
   	margin:0px auto;
   	padding: 0px;
   }
   a{
   	text-decoration:none;
   }
   .content{
   	margin:30px;
   	display: flex;
   	flex-direction: row;
   	justify-content: space-between;		

   }
   .file{
   	flex:5;
   	background-color:#CDE9FF;
   }
   .right{
   	flex:1;
   	background-color: #F4F7F8;
   }
   li{
   	list-style: none;
   }
   .file ul li{
   	display: flex;
   	/*border: 1px solid black;*/
   	margin-bottom: 10px;
   }
   span{
   	flex:1;
   }
   .right{
   	padding-left:30px;
   }
</style>
</head>
<body>
    <div class="content">
    <div class='file'>
	    <ul>
		   	<li>
		        <span>http</span>
	            <span><input type="file" id="upfile"></span> 	
	            <span><input type="text" id="toUser" placeholder="输入要传递文件的人"></span>
	            <span><button id="httpUpload" >上传文件</button></span> 
	        </li>
	        <hr>
			<li>
			   <span>文件名</span>
			   <span>下载文件</span>
			   <span>删除文件</span>
			</li>
      <li>
        <ul id="file">
        </ul>
      </li>
	    </ul>
    </div>
    <div class='right'>
        <!-- <div>
    		<span><a href="ftp://193.168.1.199" target="_blank">查看ftp文件:</a></span><br>	
		   	<span><input type="file" id="ftpUpfile"></span>
		   	<span><button id="ftp-upload">上传文件</button></span><br>
		   	<span><input type="text" id="ftpdown" placeholder="输入要下载的ftp文件"></span>
		   	<span><button id="ftp-down" onclick='down(document.getElementById('ftpdown').value)'>下载文件</button></span>
        </div> -->
		<div><b>用户:</b>
		<span id="user"> </span>
		</div>
		<div>
		 <h4>在线列表</h4>
  		<div id="user_list" style="overflow: auto;">
      </div>
		 </div>
	</div>
	</div>
</body>
<script>
  window.onload=function(){
        var ajax=new XMLHttpRequest();
        ajax.open("post",'./action.php');//post方式提交
        var data='act=user&action=logined';
        ajax.setRequestHeader("Content-type","application/x-www-form-urlencoded"); //设置http头部
        ajax.send(data);//发送数据
        ajax.onreadystatechange=function(){//
        if (ajax.readyState===4) {
          if (ajax.status===200) {
            var da=JSON.parse(ajax.responseText);//接收返回的数据格
            if (da.status=='no') {
              location.href="./login.html";
            }
          }else{
            alert("发生错误："+ajax.status);
          }
        }
      }
  }
   var username=document.cookie.split(";")[0].split("=")[1];
   document.getElementById('user').innerText=username;
	 document.getElementById('httpUpload').onclick=function(){
      var fd = new FormData();
      var ajax = new XMLHttpRequest();
      fd.append("act", 'file');
      fd.append("action",'upload');
      fd.append("touser",document.getElementById("toUser").value);
      /* 把文件添加到表单里 */
      fd.append("upfile", document.getElementById("upfile").files[0]);
      ajax.open("post", "action.php", true);
      ajax.onload = function() {
       var result=JSON.parse(ajax.responseText);
       alert(result.status);
      };
      if(document.getElementById("toUser").value!="") {
        ajax.send(fd);
      }else{
        alert("为输入传递的对象");
        return ;
      }
   }
   //  document.getElementById('ftp-upload').onclick=function(){
   //    var fd = new FormData();
   //    var ajax = new XMLHttpRequest();
   //    fd.append("act", 'ftp');
   //    fd.append("action",'upload')
   //    /* 把文件添加到表单里 */
   //    fd.append("upfile",document.getElementById("ftpUpfile").files[0]);
   //    ajax.open("post", "action.php", true);
   //    ajax.onload = function() {
   //     var result=JSON.parse(ajax.responseText);
   //     alert(result.status);
   //    };
   //    ajax.send(fd);
   // }
   // document.getElementById('ftp-down').onclick=function(){
   //    var fd = new FormData();
   //    var ajax = new XMLHttpRequest();
   //    fd.append("act", 'ftp');
   //    fd.append("action",'down')
   //    /* 把文件添加到表单里 */
   //    fd.append("file",document.getElementById("ftpdown").value);
   //    ajax.open("post", "action.php", true);
   //    ajax.onload = function() {
   //     var result=JSON.parse(ajax.responseText);
   //     alert(result.status);
   //    };
   //    ajax.send(fd);
   // }
   var files=document.getElementById('file');
   var sse=new EventSource('es.php');
   sse.addEventListener('message',function(e){
         files.innerHTML="";
        // document.getElementById("x").innerHTML="\n"+e.data.split(";");//来自服务器端的数据
        var file=e.data.split(";");
        for (var i =0; i<file.length-1; i++) {
          // console.log(files);
            var lis=document.createElement("li");
            var fileNames=document.createElement('span');
            fileNames.innerText=file[i];
            fileNames.setAttribute('id','item-'+i);
            lis.appendChild(fileNames);
            var fileNames=document.createElement('span');
            fileNames.innerHTML="<button onclick='down("+i+")'>下载文件</button>";
            lis.appendChild(fileNames);
            var fileNames=document.createElement('span');
            fileNames.innerHTML="<button onclick='del("+i+")'>删除文件</button>";
            lis.appendChild(fileNames);
            files.appendChild(lis);
        }
      },false);

    function down(we){
      var add=document.getElementById('item-'+we).innerText;
      window.open("http://localhost/grade/action.php?act=file&action=down&fileName="+add);
    }
    function del(we){
       var del=document.getElementById('item-'+we).innerText;
         var downFile=new XMLHttpRequest();
        downFile.open("post",'action.php');
        downFile.setRequestHeader("Content-type","application/x-www-form-urlencoded");
        var data='act=file&action=delete&fileName='+del;
        downFile.send(data);
        downFile.onreadystatechange=function(){//
        if (downFile.readyState===4) {
          if (downFile.status===200) {
            alert('sucess');
          }else{
            alert("发生错误："+downFile.status);
          }
        }
      }
    }
    var uname =username;
    var ws = new WebSocket("ws://127.0.0.1:8080");
    ws.onopen = function () {
        var data = "系统消息：建立连接成功";
    };

    /**
     * 分析服务器返回信息
     *
     * msg.type : user 普通信息;system 系统信息;handshake 握手信息;login 登陆信息; logout 退出信息;
     * msg.from : 消息来源
     * msg.content: 消息内容
     */
    ws.onmessage = function (e) {
        var msg = JSON.parse(e.data);
        var sender, user_name, name_list, change_type;

        switch (msg.type) {
            case 'system':
                sender = '系统消息: ';
                break;
            case 'user':
                sender = msg.from + ': ';
                break;
            case 'handshake':
                var user_info = {'type': 'login', 'content': uname};
                sendMsg(user_info);
                return;
            case 'login':
            case 'logout':
                user_name = msg.content;
                name_list = msg.user_list;
                change_type = msg.type;
                dealUser(user_name, change_type, name_list);
                return;
        }
    };

    function unique(arr){
      var res = [arr[0]];
      for(var i = 0; i < arr.length; i++){
        var repeat = false;
        for(var j = 0; j < res.length; j++){
          if(arr[i] == res[j]){
            repeat = true;
            break;
          }
        }
        if(!repeat){
          res.push(arr[i]);
        }
      }
      console.log(res);
      return res;
    }
  

    /**
     * 处理用户登陆消息
     * @param user_name 用户名
     * @param type  login/logout
     * @param name_list 用户列表
     */
    function dealUser(user_name, type, name_list) {
        var user_list = document.getElementById("user_list");
        while(user_list.hasChildNodes()) {
            user_list.removeChild(user_list.firstChild);
        }
        var name=unique(name_list);
        for (var index in name) {
          if(name[index]==username){
              continue;
          }
          // console.log(name);
            var user = document.createElement("p");
            user.innerHTML = name[index];
            user_list.appendChild(user);
        }
        user_list.scrollTop = user_list.scrollHeight;
    }

    /**
     * 将数据转为json并发送
     * @param msg
     */
    function sendMsg(msg) {
        var data = JSON.stringify(msg);
        ws.send(data);
    }
</script>
</html>
